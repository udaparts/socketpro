
Create database sp_streaming_db
GO

EXEC sp_changedbowner 'sa' ALTER DATABASE sp_streaming_db SET TRUSTWORTHY ON
GO

USE sp_streaming_db
GO

sp_configure 'clr enabled', 1
GO

RECONFIGURE
GO

-- Load usqlserver.dll into SQL server
CREATE ASSEMBLY usqlserver
AUTHORIZATION [dbo]
FROM 'C:\my_directory\usqlserver.dll' -- make sure the path to usqlserver.dll is correct!
WITH PERMISSION_SET = UNSAFE
GO


CREATE PROCEDURE StartSPServer(@res int output)As EXTERNAL NAME usqlserver.USqlStream.StartSPServer
GO

CREATE PROCEDURE StopSPServer(@res int output)As EXTERNAL NAME usqlserver.USqlStream.StopSPServer
GO	

CREATE TRIGGER tr_config ON config AFTER INSERT,DELETE,UPDATE AS EXTERNAL NAME usqlserver.USqlStream.PublishDMLEvent
GO

DECLARE @res int
EXEC sp_streaming_db.dbo.StartSPServer @res OUTPUT -- assuming the procedure created within sp_streaming_db
print @res
GO

DECLARE @res int
EXEC sp_streaming_db.dbo.StopSPServer @res OUTPUT -- assuming the procedure created within sp_streaming_db
print @res
GO

CREATE TRIGGER start_sp_server
ON ALL SERVER
FOR LOGON
AS
BEGIN
	DECLARE @res int
	EXEC sp_streaming_db.dbo.StartSPServer @res OUTPUT -- assuming the procedure created within sp_streaming_db
	if @res < 0
		BEGIN
			ROLLBACK;
		END
END
GO

-- use cmd and execute the following to check port
-- netstat -a

sqlcmd -S LocalHost -d master -A
DROP TRIGGER start_sp_server ON ALL SERVER
GO
exit